# Milestone 1 ‚Äî Core Assistant

> **Goal**: Bot is deployed, understands voice and text, onboards users, routes intents via LLM, maintains chat history, confirms mutations.
>
> **Prerequisite**: Milestone 0 (skeleton + deploy) is complete.
>
> **Done when**: User can onboard, send voice/text, bot correctly identifies intent, keeps history, confirms changes, says "I don't understand" when appropriate.

---

## Phase 1 ‚Äî Database & Users

### 1.1 Supabase Setup
- [x] Create Supabase project
- [x] Add `SUPABASE_URL` and `SUPABASE_KEY` to env
- [x] Create db client in `src/db/client.ts`
- [x] Health check on startup (via auth.getSession)
- [x] Enable Row Level Security (default on new tables)

### 1.2 Users Table
- [ ] Create migration `001_users.sql`:
  ```sql
  CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_id BIGINT UNIQUE NOT NULL,
    display_name TEXT,
    language TEXT NOT NULL DEFAULT 'en',
    timezone TEXT NOT NULL DEFAULT 'UTC',
    onboarding_step INT NOT NULL DEFAULT 0,
    onboarding_complete BOOLEAN NOT NULL DEFAULT FALSE,
    digest_morning_time TIME DEFAULT '08:00',
    digest_evening_time TIME DEFAULT '21:00',
    last_active_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  );
  ```
- [ ] Create `src/features/users/user.repo.ts` ‚Äî create, getByTelegramId, update
- [ ] TypeScript types for User

### 1.3 Auth Middleware
- [ ] Create `src/bot/middleware/auth.ts`:
  - Get telegram_id from grammY context
  - Find or create user in DB
  - Attach `ctx.user` to context
  - Update `last_active_at`
- [ ] Type the extended grammY context

### 1.4 Onboarding Guard Middleware
- [ ] Create `src/bot/middleware/onboarding-guard.ts`:
  - If `onboarding_complete = false` ‚Üí redirect to onboarding handler
  - All other handlers blocked
  - Exception: `/start`

---

## Phase 2 ‚Äî Onboarding

### 2.1 Onboarding Flow
- [ ] Create `src/features/onboarding/onboarding.handler.ts`
- [ ] Step 0 ‚Äî Welcome:
  - Bot introduces itself, brief capabilities overview
  - Auto-advance to step 1
- [ ] Step 1 ‚Äî Language:
  - Inline keyboard with common languages (üá∑üá∫ üá¨üáß üá™üá∏ üá©üá™ üá´üá∑ üáµüáπ ...)
  - Also option "Other" ‚Üí user types language name
  - Save to `language` field
  - **From this point**: all bot messages via LLM in user's language
- [ ] Step 2 ‚Äî Name:
  - Ask "How should I address you?"
  - Save to `display_name`
- [ ] Step 3 ‚Äî Timezone:
  - Inline keyboard by region (Europe ‚Üí cities, Asia ‚Üí cities...)
  - Option: send geolocation for auto-detect
  - Save to `timezone`
- [ ] Step 4 ‚Äî Digest times:
  - Morning digest time (default 08:00, show alternatives)
  - Evening digest time (default 21:00, show alternatives)
- [ ] Step 5 ‚Äî Mini tour:
  - Show 3-4 examples of what bot can do
  - Set `onboarding_complete = true`

### 2.2 Technical Details
- [ ] Onboarding handler: switch by `onboarding_step`
- [ ] Input validation at each step
- [ ] Handle unexpected input (wrong type, gibberish) ‚Äî re-ask politely
- [ ] `/setup` command ‚Äî restart onboarding for reconfiguration

### 2.3 Language Approach (NO i18n)
- [ ] Fixed UI elements (inline keyboard labels):
  - Store a minimal map of ~10 common button labels per language (Confirm, Cancel, Back, Skip, Done)
  - OR generate via LLM during onboarding and cache
- [ ] All dynamic text: generated by Claude with `language` in system prompt
- [ ] System prompt instruction: "Always respond in {language}. All text, including labels and suggestions, must be in {language}."

---

## Phase 3 ‚Äî Voice Messages

- [ ] Create `src/features/voice/voice.handler.ts`
- [ ] Handler for `message:voice` in grammY
- [ ] Download .ogg file via `ctx.getFile()`
- [ ] Convert .ogg ‚Üí .mp3 via fluent-ffmpeg
  - Ensure ffmpeg is in Docker image
  - Create temp file, delete after processing
- [ ] Send to Whisper API, get transcription
- [ ] Show user: `üé§ Heard: "transcribed text"`
- [ ] Pass transcription into main text pipeline
- [ ] Edge cases:
  - [ ] Too long voice (>5 min) ‚Äî warn and truncate
  - [ ] Empty transcription ‚Äî "Couldn't make that out, try again"
  - [ ] Whisper API error ‚Äî graceful message
  - [ ] Show typing indicator while processing

---

## Phase 4 ‚Äî LLM Intent Router

### 4.1 Claude Integration
- [ ] Create `src/core/llm/router.ts`
- [ ] `routeMessage(text, context) ‚Üí IntentResult`
- [ ] IntentResult type:
  ```typescript
  interface IntentResult {
    intent: string;        // "chat" | "help" | "unknown" | "unsupported" | "clarify"
    confidence: number;    // 0-1
    params: Record<string, any>;
    response_text: string; // in user's language
    suggested_actions?: string[];
  }
  ```

### 4.2 System Prompt v1
- [ ] Create `src/core/llm/prompts/router.v1.ts`
- [ ] Prompt includes:
  - Role: strict intent router for personal assistant
  - User context: name, language, timezone, current time
  - Available skills (from Skill Registry)
  - Rules: no hallucinations, only known intents, respond in user's language
  - JSON response format
- [ ] Confidence thresholds:
  - `>= 0.6` ‚Üí execute intent
  - `0.3 - 0.6` ‚Üí "Did you mean...?" with options
  - `< 0.3` ‚Üí "Didn't understand, try rephrasing"

### 4.3 Skill Registry
- [ ] Create `src/core/skills/registry.ts`
- [ ] Skill interface:
  ```typescript
  interface Skill {
    name: string;
    intents: string[];
    description: string;
    examples: string[];
    handler: (ctx, params) => Promise<void>;
  }
  ```
- [ ] Registry: register, find by intent, list descriptions for LLM
- [ ] Initial skills: `chat`, `help`

### 4.4 Mock LLM (dev)
- [ ] Create `src/core/llm/mock-router.ts`
- [ ] Pattern matching by keywords (no API calls)
- [ ] Toggle via `MOCK_LLM=true` in env

---

## Phase 5 ‚Äî Confirmations & History

### 5.1 Confirmation System
- [ ] Create `src/core/session/pending-actions.ts`
- [ ] In-memory Map: userId ‚Üí PendingAction
- [ ] PendingAction: intent, params, description, createdAt, TTL (5 min)
- [ ] On mutation intent:
  1. Bot shows what it's about to do (in user's language)
  2. Inline keyboard [‚úÖ Confirm] [‚ùå Cancel]
  3. Callback handler executes or cancels
- [ ] On read intent: execute immediately

### 5.2 Chat History
- [ ] Create migration `002_messages.sql`:
  ```sql
  CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role TEXT NOT NULL CHECK (role IN ('user', 'assistant')),
    content TEXT NOT NULL,
    intent TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  );
  CREATE INDEX idx_messages_user_created ON messages(user_id, created_at DESC);
  ```
- [ ] Create `src/features/messages/message.repo.ts`
- [ ] Save every message (user + assistant)
- [ ] `getRecent(userId, limit=20)` ‚Äî for LLM context
- [ ] Cron: delete messages older than 30 days

---

## Phase 6 ‚Äî Chat & Help Skills

### 6.1 Chat Skill
- [ ] Create `src/features/chat/chat.skill.ts`
- [ ] Register with intent `chat`
- [ ] Claude responds freely, uses history for context
- [ ] If chat mentions a task/date ‚Üí `suggested_actions: ["create_task"]`
  - Bot: "Want me to create a task from this?" (max 1 suggestion per exchange)

### 6.2 Help Skill
- [ ] Create `src/features/help/help.skill.ts`
- [ ] `/help` ‚Üí list all skills with examples (generated from Skill Registry)
- [ ] `/help <skill>` ‚Üí detailed help for specific skill
- [ ] `/tour` ‚Üí repeat onboarding mini-tour

---

## Testing

### Unit Tests
- [ ] Setup Vitest
- [ ] Tests for user repository (with mock Supabase)
- [ ] Tests for pending actions (TTL, confirm, cancel)
- [ ] Tests for skill registry (register, find, list)

### LLM Quality Tests
- [ ] Create `scripts/test-llm.ts` ‚Äî set of messages with expected intents
- [ ] Run manually: `npx tsx scripts/test-llm.ts`
- [ ] Output table: input | expected | actual | pass/fail

### Manual Checklist
- [ ] Onboarding: complete flow in 2+ languages
- [ ] Voice: send in Russian and English
- [ ] Chat: normal conversation, bot responds adequately
- [ ] Unknown input: bot doesn't break, responds honestly
- [ ] Gibberish: bot doesn't hallucinate
- [ ] /help and /tour work
- [ ] Deploy: everything works on Railway

---

## Definition of Done

- [ ] User can complete onboarding (language, name, timezone, digest times)
- [ ] Bot understands voice messages (Whisper)
- [ ] Bot understands text via LLM (Claude)
- [ ] Intent routing works for: chat, help, unknown, unsupported, clarify
- [ ] Mutations require confirmation
- [ ] Chat history saved and passed to LLM
- [ ] Bot honestly says when it doesn't understand or can't do something
- [ ] All communication in user's chosen language (via LLM, no i18n files)
- [ ] Deployed and working on Railway
- [ ] Basic tests pass
